import pandas as pd
import numpy as np
from rapidfuzz import fuzz
import re

def find_match(subreddit, country_map):
    name = subreddit.lower().replace("r/", "")
    tokens = re.split(r'[^a-z]+', name)
    joined = ''.join(tokens)

    for token in tokens + [joined]:
        if token in country_map:
            return country_map[token]
        
    for key in country_map:
        cleaned_key = key.replace(' ', '')
        if len(cleaned_key) < 4:  
            continue
        if name.startswith(cleaned_key) or name.endswith(cleaned_key):
            return country_map[key]
        
    if len(name) > 6:
        best_match, best_score = None, 0
        for key, country in country_map.items():
            if len(key) < 4:  
                continue
            score = fuzz.partial_ratio(key, name)
            if score > 90 and score > best_score:
                best_match, best_score = country, score
        return best_match
        
    return None

def filter_countries(origin_folder, final_folder):
    df_title = pd.read_csv(origin_folder+"soc-redditHyperlinks-title.tsv", sep="\t")
    df_body = pd.read_csv(origin_folder+"soc-redditHyperlinks-body.tsv", sep="\t")

    time_format = '%Y-%m-%d %H:%M:%S'
    df_title['TIMESTAMP'] = pd.to_datetime(df_title['TIMESTAMP'], format=time_format)
    df_body['TIMESTAMP'] = pd.to_datetime(df_body['TIMESTAMP'], format=time_format)
    post_props_cols = [
    "num_chars", "num_chars_no_space", "frac_alpha", "frac_digits",
    "frac_upper", "frac_spaces", "frac_special", "num_words",
    "num_unique_words", "num_long_words", "avg_word_length",
    "num_unique_stopwords", "frac_stopwords", "num_sentences",
    "num_long_sentences", "avg_chars_per_sentence", "avg_words_per_sentence",
    "readability_index", "sent_pos", "sent_neg", "sent_compound",
    "LIWC_Funct", "LIWC_Pronoun", "LIWC_Ppron", "LIWC_I", "LIWC_We",
    "LIWC_You", "LIWC_SheHe", "LIWC_They", "LIWC_Ipron", "LIWC_Article",
    "LIWC_Verbs", "LIWC_AuxVb", "LIWC_Past", "LIWC_Present", "LIWC_Future",
    "LIWC_Adverbs", "LIWC_Prep", "LIWC_Conj", "LIWC_Negate", "LIWC_Quant",
    "LIWC_Numbers", "LIWC_Swear", "LIWC_Social", "LIWC_Family",
    "LIWC_Friends", "LIWC_Humans", "LIWC_Affect", "LIWC_Posemo",
    "LIWC_Negemo", "LIWC_Anx", "LIWC_Anger", "LIWC_Sad", "LIWC_CogMech",
    "LIWC_Insight", "LIWC_Cause", "LIWC_Discrep", "LIWC_Tentat",
    "LIWC_Certain", "LIWC_Inhib", "LIWC_Incl", "LIWC_Excl", "LIWC_Percept",
    "LIWC_See", "LIWC_Hear", "LIWC_Feel", "LIWC_Bio", "LIWC_Body",
    "LIWC_Health", "LIWC_Sexual", "LIWC_Ingest", "LIWC_Relativ",
    "LIWC_Motion", "LIWC_Space", "LIWC_Time", "LIWC_Work", "LIWC_Achiev",
    "LIWC_Leisure", "LIWC_Home", "LIWC_Money", "LIWC_Relig", "LIWC_Death",
    "LIWC_Assent", "LIWC_Dissent", "LIWC_Nonflu", "LIWC_Filler"
    ]

    df_body[post_props_cols] = df_body["PROPERTIES"].str.split(",", expand=True).astype(float)
    df_title[post_props_cols] = df_title["PROPERTIES"].str.split(",", expand=True).astype(float)

    df_body = df_body.drop(columns=["PROPERTIES"])
    df_title = df_title.drop(columns=["PROPERTIES"])
    
    df_combined = pd.concat([df_body, df_title], ignore_index=True)

    all_subreddits_series = pd.concat([df_combined['SOURCE_SUBREDDIT'], df_combined['TARGET_SUBREDDIT']])

    unique_subreddit_list = all_subreddits_series.unique().tolist()

    country_map = {}

    # A dictionary mapping native country names to standardized English names
    native_names_map = {
        # ----- EUROPE -----
        'germany': 'Germany',
        'deutschland': 'Germany',
        'german': 'Germany',
        'alemania': 'Germany',
        'allemagne': 'Germany',
        'france': 'France',
        'français': 'France',
        'french': 'France',
        'republique francaise': 'France',
        'italy': 'Italy',
        'italia': 'Italy',
        'italian': 'Italy',
        'italiano': 'Italy',
        'repubblica italiana': 'Italy',
        'spain': 'Spain',
        'españa': 'Spain',
        'espana': 'Spain',
        'spanish': 'Spain',
        'espanol': 'Spain',
        'united kingdom': 'United Kingdom',
        'great britain': 'United Kingdom',
        'britain': 'United Kingdom',
        'british': 'United Kingdom',
        'england': 'United Kingdom',
        'netherlands': 'Netherlands',
        'nederland': 'Netherlands',
        'holland': 'Netherlands',
        'dutch': 'Netherlands',
        'oland': 'Netherlands',
        'portugal': 'Portugal',
        'portuguese': 'Portugal',
        'switzerland': 'Switzerland',
        'schweiz': 'Switzerland',
        'suisse': 'Switzerland',
        'svizzera': 'Switzerland',
        'swiss': 'Switzerland',
        'austria': 'Austria',
        'österreich': 'Austria',
        'austrian': 'Austria',
        'belgium': 'Belgium',
        'belgië': 'Belgium',
        'belgique': 'Belgium',
        'belgian': 'Belgium',
        'greece': 'Greece',
        'ellada': 'Greece',
        'Ελλάδα': 'Greece',
        'greek': 'Greece',
        'hellas': 'Greece',
        'poland': 'Poland',
        'polska': 'Poland',
        'polish': 'Poland',
        'sweden': 'Sweden',
        'sverige': 'Sweden',
        'swedish': 'Sweden',
        'svenska': 'Sweden',
        'norway': 'Norway',
        'norge': 'Norway',
        'norsk': 'Norway',
        'norwegian': 'Norway',
        'denmark': 'Denmark',
        'danmark': 'Denmark',
        'danish': 'Denmark',
        'dansk': 'Denmark',
        'finland': 'Finland',
        'suomi': 'Finland',
        'finnish': 'Finland',
        'iceland': 'Iceland',
        'íslensku': 'Iceland',
        'russia': 'Russia',
        'rossiya': 'Russia',
        'Россия': 'Russia',
        'russian': 'Russia',
        'ukraine': 'Ukraine',
        'ukrayina': 'Ukraine',
        'Україна': 'Ukraine',
        'ukrainian': 'Ukraine',
        'hungary': 'Hungary',
        'magyarország': 'Hungary',
        'romania': 'Romania',
        'românia': 'Romania',
        'czechia': 'Czechia',
        'czech': 'Czechia',
        'česko': 'Czechia',
        'czech republic': 'Czechia',
        'croatia': 'Croatia',
        'hrvatska': 'Croatia',
        'serbia': 'Serbia',
        'srbija': 'Serbia',
        'lietuva': 'Lithuania',
        'lithuania': 'Lithuania',
        'latvija': 'Latvia',
        'latvia': 'Latvia',
        'eesti': 'Estonia',
        'estonia': 'Estonia',
        'ireland': 'Ireland',
        'eire': 'Ireland',
        'irish': 'Ireland',
        
        # --- New Europe additions ---
        'albania': 'Albania',
        'armenia': 'Armenia',
        'belarus': 'Belarus',
        'bulgaria': 'Bulgaria',
        'cyprus': 'Cyprus',
        'luxembourg': 'Luxembourg',
        'malta': 'Malta',
        'moldova': 'Moldova',
        'moldova, republic of': 'Moldova',
        'montenegro': 'Montenegro',
        'north macedonia': 'North Macedonia',
        'macedonia': 'North Macedonia',
        'slovakia': 'Slovakia',
        'slovenia': 'Slovenia',
        'andorra': 'Andorra',
        'monaco': 'Monaco',
        'liechtenstein': 'Liechtenstein',
        'faroe islands': 'Faroe Islands',
        'gibraltar': 'Gibraltar',
        'isle of man': 'Isle of Man',
        'jersey': 'Jersey',
        'åland islands': 'Åland Islands',
        'aland islands': 'Åland Islands',
        'georgia': 'Georgia', 

        # ----- EUROPA (3 main cities for each country) -----
        'berlin': 'Germany',
        'hamburg': 'Germany',
        'munich': 'Germany',
        'paris': 'France',
        'marseille': 'France',
        'lyon': 'France',
        'rome': 'Italy',
        'milan': 'Italy',
        'naples': 'Italy',
        'madrid': 'Spain',
        'barcelona': 'Spain',
        'valencia': 'Spain',
        'london': 'United Kingdom',
        'birmingham': 'United Kingdom',
        'leeds': 'United Kingdom',
        'amsterdam': 'Netherlands',
        'rotterdam': 'Netherlands',
        'the hague': 'Netherlands',
        'lisbon': 'Portugal',
        'porto': 'Portugal',
        'sintra': 'Portugal',
        'zurich': 'Switzerland',
        'geneva': 'Switzerland',
        'basel': 'Switzerland',
        'vienna': 'Austria',
        'graz': 'Austria',
        'linz': 'Austria',
        'brussels': 'Belgium',
        'antwerp': 'Belgium',
        'ghent': 'Belgium',
        'athens': 'Greece',
        'thessaloniki': 'Greece',
        'patras': 'Greece',
        'warsaw': 'Poland',
        'kraków': 'Poland',
        'wrocław': 'Poland',
        'stockholm': 'Sweden',
        'gothenburg': 'Sweden',
        'malmö': 'Sweden',
        'oslo': 'Norway',
        'bergen': 'Norway',
        'stavanger': 'Norway',
        'copenhagen': 'Denmark',
        'aarhus': 'Denmark',
        'odense': 'Denmark',
        'helsinki': 'Finland',
        'tampere': 'Finland',
        'turku': 'Finland',
        'reykjavík': 'Iceland',
        'kopavogur': 'Iceland',
        'hafnarfjörður': 'Iceland',
        'moscow': 'Russia',
        'saint petersburg': 'Russia',
        'novosibirsk': 'Russia',
        'kyiv': 'Ukraine',
        'kharkiv': 'Ukraine',
        'odesa': 'Ukraine',
        'budapest': 'Hungary',
        'debrecen': 'Hungary',
        'szeged': 'Hungary',
        'bucharest': 'Romania',
        'cluj-napoca': 'Romania',
        'iași': 'Romania',
        'prague': 'Czechia',
        'brno': 'Czechia',
        'ostrava': 'Czechia',
        'zagreb': 'Croatia',
        'split': 'Croatia',
        'rijeka': 'Croatia',
        'belgrade': 'Serbia',
        'novi sad': 'Serbia',
        'niš': 'Serbia',
        'vilnius': 'Lithuania',
        'kaunas': 'Lithuania',
        'klaipėda': 'Lithuania',
        'riga': 'Latvia',
        'daugavpils': 'Latvia',
        'liepāja': 'Latvia',
        'tallinn': 'Estonia',
        'tartu': 'Estonia',
        'narva': 'Estonia',
        'dublin': 'Ireland',
        'cork': 'Ireland',
        'limerick': 'Ireland',

        # ----- AMERICAS -----
        'united states': 'USA',
        'usa': 'USA',
        'america': 'USA',
        'american': 'USA',
        'united states of america': 'USA',
        'canada': 'Canada',
        'canadian': 'Canada',
        'mexico': 'Mexico',
        'méxico': 'Mexico',
        'mejico': 'Mexico',
        'mexican': 'Mexico',
        'brazil': 'Brazil',
        'brasil': 'Brazil',
        'brazilian': 'Brazil',
        'argentina': 'Argentina',
        'argentine': 'Argentina',
        'colombia': 'Colombia',
        'peru': 'Peru',
        'perú': 'Peru',
        'chile': 'Chile',
        'venezuela': 'Venezuela',

        # --- New Americas additions ---
        'anguilla': 'Anguilla',
        'bahamas': 'Bahamas',
        'barbados': 'Barbados',
        'belize': 'Belize',
        'bermuda': 'Bermuda',
        'bolivia': 'Bolivia',
        'bolivia, plurinational state of': 'Bolivia',
        'british virgin islands': 'British Virgin Islands',
        'virgin islands, british': 'British Virgin Islands',
        'cayman islands': 'Cayman Islands',
        'cuba': 'Cuba',
        'dominica': 'Dominica',
        'ecuador': 'Ecuador',
        'el salvador': 'El Salvador',
        'greenland': 'Greenland',
        'guatemala': 'Guatemala',
        'guyana': 'Guyana',
        'haiti': 'Haiti',
        'honduras': 'Honduras',
        'jamaica': 'Jamaica',
        'martinique': 'Martinique',
        'montserrat': 'Montserrat',
        'nicaragua': 'Nicaragua',
        'panama': 'Panama',
        'paraguay': 'Paraguay',
        'puerto rico': 'Puerto Rico',
        'suriname': 'Suriname',
        'trinidad and tobago': 'Trinidad and Tobago',
        'uruguay': 'Uruguay',

        # ----- AMERICAS cities -----
        'toronto': 'Canada',
        'montreal': 'Canada',
        'calgary': 'Canada',
        'mexico city': 'Mexico',
        'tijuana': 'Mexico',
        'león': 'Mexico',
        'são paulo': 'Brazil',
        'rio de janeiro': 'Brazil',
        'brasília': 'Brazil',
        'buenos aires': 'Argentina',
        'córdoba': 'Argentina',
        'rosario': 'Argentina',
        'bogotá': 'Colombia',
        'medellín': 'Colombia',
        'cali': 'Colombia',
        'lima': 'Peru',
        'arequipa': 'Peru',
        'trujillo': 'Peru',
        'santiago': 'Chile',
        'puente alto': 'Chile',
        'antofagasta': 'Chile',
        'caracas': 'Venezuela',
        'maracaibo': 'Venezuela',
        'valencia': 'Venezuela',

        # ----- US States and Cities -----
        'new york city': 'USA', 
        'los angeles': 'USA',    
        'chicago': 'USA',       
        # Stati
        'alabama': 'USA',
        'alaska': 'USA',
        'arizona': 'USA',
        'arkansas': 'USA',
        'california': 'USA',
        'colorado': 'USA',
        'connecticut': 'USA',
        'delaware': 'USA',
        'florida': 'USA',
        'georgia': 'USA',
        'hawaii': 'USA',
        'idaho': 'USA',
        'illinois': 'USA',
        'indiana': 'USA',
        'iowa': 'USA',
        'kansas': 'USA',
        'kentucky': 'USA',
        'louisiana': 'USA',
        'maine': 'USA',
        'maryland': 'USA',
        'massachusetts': 'USA',
        'michigan': 'USA',
        'minnesota': 'USA',
        'mississippi': 'USA',
        'missouri': 'USA',
        'montana': 'USA',
        'nebraska': 'USA',
        'nevada': 'USA',
        'new hampshire': 'USA',
        'new jersey': 'USA',
        'new mexico': 'USA',
        'new york': 'USA',
        'north carolina': 'USA',
        'north dakota': 'USA',
        'ohio': 'USA',
        'oklahoma': 'USA',
        'oregon': 'USA',
        'pennsylvania': 'USA',
        'rhode island': 'USA',
        'south carolina': 'USA',
        'south dakota': 'USA',
        'tennessee': 'USA',
        'texas': 'USA',
        'utah': 'USA',
        'vermont': 'USA',
        'virginia': 'USA',
        'washington': 'USA',
        'west virginia': 'USA',
        'wisconsin': 'USA',
        'wyoming': 'USA',
        # Capitals
        'montgomery': 'USA',
        'juneau': 'USA',
        'phoenix': 'USA',
        'little rock': 'USA',
        'sacramento': 'USA',
        'denver': 'USA',
        'hartford': 'USA',
        'dover': 'USA',
        'tallahassee': 'USA',
        'atlanta': 'USA',
        'honolulu': 'USA',
        'boise': 'USA',
        'springfield': 'USA',
        'indianapolis': 'USA',
        'des moines': 'USA',
        'topeka': 'USA',
        'frankfort': 'USA',
        'baton rouge': 'USA',
        'augusta': 'USA',
        'annapolis': 'USA',
        'boston': 'USA',
        'lansing': 'USA',
        'saint paul': 'USA',
        'jackson': 'USA',
        'jefferson city': 'USA',
        'helena': 'USA',
        'lincoln': 'USA',
        'carson city': 'USA',
        'concord': 'USA',
        'trenton': 'USA',
        'santa fe': 'USA',
        'albany': 'USA',
        'raleigh': 'USA',
        'bismarck': 'USA',
        'columbus': 'USA',
        'oklahoma city': 'USA',
        'salem': 'USA',
        'harrisburg': 'USA',
        'providence': 'USA',
        'columbia': 'USA',
        'pierre': 'USA',
        'nashville': 'USA',
        'austin': 'USA',
        'salt lake city': 'USA',
        'montpelier': 'USA',
        'richmond': 'USA',
        'olympia': 'USA',
        'charleston': 'USA',
        'madison': 'USA',
        'cheyenne': 'USA',

        # ----- ASIA and OCEANIA -----
        'china': 'China',
        'zhongguo': 'China',
        '中国': 'China',
        'chinese': 'China',
        'prc': 'China',
        'japan': 'Japan',
        'nippon': 'Japan',
        'nihon': 'Japan',
        '日本': 'Japan',
        'japanese': 'Japan',
        'india': 'India',
        'bharat': 'India',
        'भारत': 'India',
        'indian': 'India',
        'south korea': 'South Korea',
        'hanguk': 'South Korea',
        '한국': 'South Korea',
        'korea': 'South Korea',
        'republic of korea': 'South Korea',
        'north korea': 'North Korea',
        'dprk': 'North Korea',
        'australia': 'Australia',
        'australian': 'Australia',
        'new zealand': 'New Zealand',
        'kiwi': 'New Zealand',
        'indonesia': 'Indonesia',
        'vietnam': 'Vietnam',
        'việtnam': 'Vietnam',
        'thailand': 'Thailand',
        'thai': 'Thailand',
        'philippines': 'Philippines',
        'pinoy': 'Philippines',
        'pilipinas': 'Philippines',
        'malaysia': 'Malaysia',
        'singapore': 'Singapore',
        'pakistan': 'Pakistan',
        'bangladesh': 'Bangladesh',

        # --- New Asia/Oceania additions ---
        'afghanistan': 'Afghanistan',
        'azerbaijan': 'Azerbaijan',
        'bahrain': 'Bahrain',
        'bhutan': 'Bhutan',
        'cambodia': 'Cambodia',
        'fiji': 'Fiji',
        'fijian': 'Fiji',
        'guam': 'Guam',
        'hong kong': 'Hong Kong',
        'iraq': 'Iraq',
        'jordan': 'Jordan',
        'kazakhstan': 'Kazakhstan',
        'kuwait': 'Kuwait',
        'kyrgyzstan': 'Kyrgyzstan',
        'lebanon': 'Lebanon',
        'maldives': 'Maldives',
        'mongolia': 'Mongolia',
        'myanmar': 'Myanmar',
        'nepal': 'Nepal',
        'norfolk island': 'Norfolk Island',
        'oman': 'Oman',
        'palau': 'Palau',
        'pitcairn': 'Pitcairn',
        'qatar': 'Qatar',
        'samoa': 'Samoa',
        'solomon islands': 'Solomon Islands',
        'sri lanka': 'Sri Lanka',
        'tajikistan': 'Tajikistan',
        'tonga': 'Tonga',
        'turkmenistan': 'Turkmenistan',
        'tuvalu': 'Tuvalu',
        'uzbekistan': 'Uzbekistan',
        'vanuatu': 'Vanuatu',
        'viet nam': 'Vietnam',
        'yemen': 'Yemen',

        # ----- ASIA and OCEANIA (3 main cities) -----
        'shanghai': 'China',
        'beijing': 'China',
        'guangzhou': 'China',
        'tokyo': 'Japan',
        'yokohama': 'Japan',
        'osaka': 'Japan',
        'mumbai': 'India',
        'delhi': 'India',
        'kolkata': 'India',
        'seoul': 'South Korea',
        'busan': 'South Korea',
        'incheon': 'South Korea',
        'pyongyang': 'North Korea',
        'chongjin': 'North Korea',
        'hamhung': 'North Korea',
        'sydney': 'Australia',
        'melbourne': 'Australia',
        'brisbane': 'Australia',
        'auckland': 'New Zealand',
        'christchurch': 'New Zealand',
        'wellington': 'New Zealand',
        'jakarta': 'Indonesia',
        'surabaya': 'Indonesia',
        'bandung': 'Indonesia',
        'ho chi minh city': 'Vietnam',
        'hanoi': 'Vietnam',
        'hai phong': 'Vietnam',
        'bangkok': 'Thailand',
        'mueang samut prakan': 'Thailand',
        'nonthaburi': 'Thailand',
        'quezon city': 'Philippines',
        'manila': 'Philippines',
        'davao city': 'Philippines',
        'kuala lumpur': 'Malaysia',
        'petaling jaya': 'Malaysia',
        'klang': 'Malaysia',
        'bedok': 'Singapore',
        'sengkang': 'Singapore',
        'jurong west': 'Singapore', 
        'karachi': 'Pakistan',
        'lahore': 'Pakistan',
        'faisalabad': 'Pakistan',
        'dhaka': 'Bangladesh',
        'chittagong': 'Bangladesh',
        'gazipur': 'Bangladesh',

        # ----- MIDDLE EAST AND AFRICA -----
        'turkey': 'Turkey',
        'türkiye': 'Turkey',
        'turkish': 'Turkey',
        'iran': 'Iran',
        'persia': 'Iran',
        'saudi arabia': 'Saudi Arabia',
        'ksa': 'Saudi Arabia',
        'al-arabiyyah as-saudiyyah': 'Saudi Arabia',
        'egypt': 'Egypt',
        'misr': 'Egypt',
        'egyptian': 'Egypt',
        'south africa': 'South Africa',
        'suid-afrika': 'South Africa',
        'nigeria': 'Nigeria',
        'kenya': 'Kenya',
        'morocco': 'Morocco',
        'maroc': 'Morocco',
        'israel': 'Israel',
        'palestine': 'Palestine',
        'state of palestine': 'Palestine',
        'filastin': 'Palestine',
        'uae': 'United Arab Emirates',
        'united arab emirates': 'United Arab Emirates',
        'emirates': 'United Arab Emirates',
        
        # --- New Middle East/Africa/Antarctica additions ---
        'algeria': 'Algeria',
        'angola': 'Angola',
        'benin': 'Benin',
        'botswana': 'Botswana',
        'burkina faso': 'Burkina Faso',
        'burundi': 'Burundi',
        'cameroon': 'Cameroon',
        'comoros': 'Comoros',
        'congo': 'Congo',
        'republic of congo': 'Congo',
        'djibouti': 'Djibouti',
        'eritrea': 'Eritrea',
        'ethiopia': 'Ethiopia',
        'gabon': 'Gabon',
        'gambia': 'Gambia',
        'ghana': 'Ghana',
        'guinea': 'Guinea',
        'guinea-bissau': 'Guinea-Bissau',
        'lesotho': 'Lesotho',
        'liberia': 'Liberia',
        'libya': 'Libya',
        'madagascar': 'Madagascar',
        'malawi': 'Malawi',
        'mali': 'Mali',
        'mauritania': 'Mauritania',
        'mauritius': 'Mauritius',
        'mozambique': 'Mozambique',
        'namibia': 'Namibia',
        'niger': 'Niger',
        'rwanda': 'Rwanda',
        'senegal': 'Senegal',
        'sierra leone': 'Sierra Leone',
        'somalia': 'Somalia',
        'south sudan': 'South Sudan',
        'sudan': 'Sudan',
        'tanzania': 'Tanzania',
        'tanzania, united republic of': 'Tanzania',
        'togo': 'Togo',
        'tunisia': 'Tunisia',
        'uganda': 'Uganda',
        'western sahara': 'Western Sahara',
        'zambia': 'Zambia',
        'zimbabwe': 'Zimbabwe',
        'antarctica': 'Antarctica',
        'palestine, state of': 'Palestine',

        # ----- MIDDLE EAST AND  AFRICA (3 main cities) -----
        'istanbul': 'Turkey',
        'ankara': 'Turkey',
        'izmir': 'Turkey',
        'tehran': 'Iran',
        'mashhad': 'Iran',
        'isfahan': 'Iran',
        'riyadh': 'Saudi Arabia',
        'jeddah': 'Saudi Arabia',
        'mecca': 'Saudi Arabia',
        'cairo': 'Egypt',
        'alexandria': 'Egypt',
        'giza': 'Egypt',
        'johannesburg': 'South Africa',
        'cape town': 'South Africa',
        'durban': 'South Africa',
        'lagos': 'Nigeria',
        'kano': 'Nigeria',
        'ibadan': 'Nigeria',
        'nairobi': 'Kenya',
        'mombasa': 'Kenya',
        'kisumu': 'Kenya',
        'casablanca': 'Morocco',
        'rabat': 'Morocco',
        'fes': 'Morocco',
        'jerusalem': 'Israel',
        'tel aviv': 'Israel',
        'haifa': 'Israel',
        'dubai': 'United Arab Emirates',
        'abu dhabi': 'United Arab Emirates',
        'sharjah': 'United Arab Emirates',
    }
    country_map.update(native_names_map)
    
    matches = {}

    for s in unique_subreddit_list:
        country = find_match(s, country_map)
        if country:
            matches[s] = country

    df_combined["SOURCE_COUNTRY"] = df_combined["SOURCE_SUBREDDIT"].map(matches)
    df_combined["TARGET_COUNTRY"] = df_combined["TARGET_SUBREDDIT"].map(matches)

    df_country = df_combined.dropna(subset=['SOURCE_COUNTRY', 'TARGET_COUNTRY'], how='all')

    new_order = ["SOURCE_SUBREDDIT","SOURCE_COUNTRY", "TARGET_SUBREDDIT", "TARGET_COUNTRY", "POST_ID", "TIMESTAMP", "LINK_SENTIMENT", 
        "num_chars", "num_chars_no_space", "frac_alpha", "frac_digits",
        "frac_upper", "frac_spaces", "frac_special", "num_words",
        "num_unique_words", "num_long_words", "avg_word_length",
        "num_unique_stopwords", "frac_stopwords", "num_sentences",
        "num_long_sentences", "avg_chars_per_sentence", "avg_words_per_sentence",
        "readability_index", "sent_pos", "sent_neg", "sent_compound",
        "LIWC_Funct", "LIWC_Pronoun", "LIWC_Ppron", "LIWC_I", "LIWC_We",
        "LIWC_You", "LIWC_SheHe", "LIWC_They", "LIWC_Ipron", "LIWC_Article",
        "LIWC_Verbs", "LIWC_AuxVb", "LIWC_Past", "LIWC_Present", "LIWC_Future",
        "LIWC_Adverbs", "LIWC_Prep", "LIWC_Conj", "LIWC_Negate", "LIWC_Quant",
        "LIWC_Numbers", "LIWC_Swear", "LIWC_Social", "LIWC_Family",
        "LIWC_Friends", "LIWC_Humans", "LIWC_Affect", "LIWC_Posemo",
        "LIWC_Negemo", "LIWC_Anx", "LIWC_Anger", "LIWC_Sad", "LIWC_CogMech",
        "LIWC_Insight", "LIWC_Cause", "LIWC_Discrep", "LIWC_Tentat",
        "LIWC_Certain", "LIWC_Inhib", "LIWC_Incl", "LIWC_Excl", "LIWC_Percept",
        "LIWC_See", "LIWC_Hear", "LIWC_Feel", "LIWC_Bio", "LIWC_Body",
        "LIWC_Health", "LIWC_Sexual", "LIWC_Ingest", "LIWC_Relativ",
        "LIWC_Motion", "LIWC_Space", "LIWC_Time", "LIWC_Work", "LIWC_Achiev",
        "LIWC_Leisure", "LIWC_Home", "LIWC_Money", "LIWC_Relig", "LIWC_Death",
        "LIWC_Assent", "LIWC_Dissent", "LIWC_Nonflu", "LIWC_Filler"]

    df_country = df_country[new_order]

    df_country.to_csv(final_folder+"df_country_expanded.csv", index=False)
    df_matches_list = pd.DataFrame(matches.items(), columns=['Subreddit', 'Country'])
    df_matches_list.to_csv(final_folder+'country_matches_map_expanded.csv', index=False)


filter_countries("data/", "data/")